# Daily Monitor (电脑使用时长监测系统)

一个自动化、本地化的电脑使用行为追踪系统，用于记录并可视化每日应用使用情况和网页浏览时长。专为 Windows 优化，确保极低的性能开销。

## 🏗 项目架构

系统由以下三个核心部分组成：

### 1. 服务端 (Node.js)
- **位置**: `/server`
- **角色**: 系统的核心控制枢纽。
- **关键功能**:
  - **窗口追踪**: 使用 `active-win` 每 **1 秒** 轮询一次当前活动窗口。
  - **挂机检测**: 运行一个轻量级的 C# 子进程 (`IdleCheck.exe`)。如果系统超过 **120 秒** 无输入，追踪将自动暂停。
  - **持久化存储**: 数据存储在本地 SQLite 数据库 (`server/history.db`) 中。
    - **优化**: 开启 **WAL 模式** (Write-Ahead Logging) 确保读写不冲突，不卡顿。
    - **写入缓冲**: 每 **10 秒** 更新一次硬盘，减少磁盘 I/O 开销。
  - **API**: 为前端提供数据接口，并接收来自 Chrome 扩展的实时 URL 更新。

### 2. 前端看板 (React + Vite)
- **位置**: `/client`
- **角色**: 数据可视化展示面板。
- **关键功能**:
  - **技术栈**: React, Recharts, Axios。
  - **智能轮询**: 仅在网页可见时每 **3 秒** 刷新一次数据。当网页被最小化或切到后台时自动休眠（确保打游戏时 **0 资源占用**）。
  - **图表展示**: 提供饼图和柱状图，直观展示每日时间分配。

### 3. Chrome 浏览器扩展
- **位置**: `/chrome-extension`
- **角色**: 增强监测粒度。
- **功能**: 由于操作系统限制，仅靠窗口标题无法准确获取浏览器内的详细 URL。该扩展会在切换标签页或跳转页面时，将当前 URL 和标题发送给本地服务端。

---

## 🚀 部署与启动

### 环境准备
- **Node.js**: v16 或更高版本。
- **Windows 系统**: 必须在 Windows 环境下运行（依赖 Windows 原生 API）。

### 安装步骤

1.  **安装服务端依赖**:
    ```bash
    npm install
    ```

2.  **安装前端依赖**:
    ```bash
    cd client
    npm install
    ```

3.  **构建前端**:
    ```bash
    cd client
    npm run build
    ```
    *(构建完成后，服务端将自动在 `http://localhost:3001` 托管看板)*

4.  **安装 Chrome 扩展**:
    - 打开 Chrome 浏览器，访问 `chrome://extensions/`。
    - 开启右上角的 **开发者模式**。
    - 点击 **加载已解压的扩展程序**。
    - 选择本项目中的 `chrome-extension` 文件夹。

### 如何运行

#### 方式 A：后台静默运行（推荐日常使用）
双击根目录下的 **`run_monitor_bg.vbs`**。
- 这将在后台启动服务端，不显示命令行窗口。
- 之后直接访问 `http://localhost:3001` 查看看板。

#### 方式 B：前台运行（用于调试）
在根目录下运行：
```bash
npm start
```

### 如何停止
双击根目录下的 **`stop_monitor.bat`** 即可彻底关闭监控进程。

---

## 🛠 性能优化说明

为了确保监控不影响打游戏等高性能任务，我们实施了以下优化：

- **挂机逻辑**:
  - `IDLE_THRESHOLD_SECONDS = 120`: 离开电脑 2 分钟自动停表。
  - `IdleCheck.exe`: 常驻后台，通过标准输入输出通信，避免了频繁启动进程的巨大开销。

- **轮询频率**:
  - **活跃窗口**: 每 **1000ms** (1秒) 检测一次。
  - **数据库写入**: 每 **~1000ms** (约1秒) 批量写入一次。
  - **前端刷新**: 每 **1000ms** (1秒) 刷新，后台自动停止。

- **数据库优化**:
  - `server/db.js`: 强制开启 `PRAGMA journal_mode = WAL`，解决读写锁导致的瞬间微卡顿。

---

## 📂 核心文件参考

- `server/monitor.js`: 核心监测逻辑与会话管理。
- `server/tools/IdleCheck.cs`: 挂机检测工具源码。
- `server/db.js`: 数据库模式与分类规则。
- `client/src/App.jsx`: 前端界面与智能刷新逻辑。
